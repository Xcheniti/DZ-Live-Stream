name: ğŸ¥ Echorouk Live Stream Extractor

on:
  workflow_dispatch:  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙƒÙ„ 4 Ø³Ø§Ø¹Ø§Øª (0, 4, 8, 12, 16, 20)
    - cron: '0 */4 * * *'
  push:
    branches: [ main, master ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  extract-stream:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: ğŸ Setup Python ${{ env.PYTHON_VERSION }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests==2.31.0 beautifulsoup4==4.12.2 lxml==4.9.3
        pip install yt-dlp==2023.11.16 --no-deps
    
    - name: ğŸ” Run Stream Extractor
      id: extractor
      run: |
        echo "=== STARTING EXTRACTION ==="
        echo "Time: $(date)"
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        mkdir -p results logs
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        python extractor.py
        
        # Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        if [ -f "results/status.json" ]; then
          STATUS=$(python -c "import json; print(json.load(open('results/status.json'))['status'])")
          URL=$(python -c "import json; print(json.load(open('results/status.json')).get('best_url', ''))")
          
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "stream_url=$URL" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -Iseconds)" >> $GITHUB_OUTPUT
        else
          echo "status=error" >> $GITHUB_OUTPUT
          echo "stream_url=" >> $GITHUB_OUTPUT
        fi
        
        echo "=== EXTRACTION COMPLETE ==="
    
    - name: ğŸ“Š Upload Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: stream-results
        path: |
          results/
          logs/
        retention-days: 7
    
    - name: ğŸ“ Auto Commit Results
      if: steps.extractor.outputs.status == 'success'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        git add results/ || echo "No results to add"
        git add logs/ || echo "No logs to add"
        
        # Commit ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ ØªØºÙŠÙŠØ±Ø§Øª
        git diff --staged --quiet || {
          git commit -m "ğŸ”„ Auto-update: $(date '+%Y-%m-%d %H:%M')
          
          Status: ${{ steps.extractor.outputs.status }}
          Stream URL: ${{ steps.extractor.outputs.stream_url }}
          "
          
          git push
          echo "âœ… Successfully committed and pushed"
        } || echo "â„¹ï¸ No changes to commit"
    
    - name: ğŸ‰ Success Notification
      if: success()
      run: |
        echo "========================================"
        echo "âœ… EXTRACTION SUCCESSFUL"
        echo "Time: ${{ steps.extractor.outputs.timestamp }}"
        echo "Status: ${{ steps.extractor.outputs.status }}"
        echo "========================================"
    
    - name: âš ï¸ Failure Notification
      if: failure()
      run: |
        echo "========================================"
        echo "âŒ EXTRACTION FAILED"
        echo "Check logs for details"
        echo "========================================"
