name: ğŸ¥ Ù…Ø³ØªØ®Ø±Ø¬ Ø¨Ø« Ø§Ù„Ø´Ø±ÙˆÙ‚ Ù†ÙŠÙˆØ² Ø§Ù„Ø¢Ù„ÙŠ
on:
  workflow_dispatch:  # ØªØ´ØºÙŠÙ„ ÙŠØ¯ÙˆÙŠ
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙƒÙ„ 3 Ø³Ø§Ø¹Ø§Øª (0,3,6,9,12,15,18,21)
    - cron: '0 */3 * * *'
  push:
    branches: [ main, master ]

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "echorouk-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  extract-stream:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: '**/requirements.txt'
    
    - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯Ø§Øª
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt --no-cache-dir
        pip install git+https://github.com/yt-dlp/yt-dlp.git@master
    
    - name: ğŸ” ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…
      id: extract
      run: |
        echo "â° ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ”„ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬..."
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ù…Ø¹ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        python echorouk_super_extractor.py 2>&1 | tee extraction.log
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬
        if [ -f "results/extraction_status.json" ]; then
          STATUS=$(python -c "import json; print(json.load(open('results/extraction_status.json'))['status'])")
          URL=$(python -c "import json; print(json.load(open('results/extraction_status.json'))['best_url'][:100] if 'best_url' in json.load(open('results/extraction_status.json')) else '')")
          
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "stream_url=$URL" >> $GITHUB_OUTPUT
          echo "timestamp=$(date -Iseconds)" >> $GITHUB_OUTPUT
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          exit 1
        fi
        
        echo "âœ… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§ÙƒØªÙ…Ù„Øª"
    
    - name: ğŸ“Š ØªØ­Ù„ÙŠÙ„ ÙˆØ±ÙØ¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      if: steps.extract.outputs.status == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: echorouk-stream-results
        path: |
          results/
          logs/
          *.m3u
          *.json
        retention-days: 30
    
    - name: ğŸ“ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      if: steps.extract.outputs.status == 'success'
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
        git add -A
        git diff --cached --quiet || {
          git commit -m "ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø¢Ù„ÙŠ Ù„Ù„Ø¨Ø« [${{ steps.extract.outputs.timestamp }}]
          
          â€¢ ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø¨Ø«
          â€¢ Ø§Ù„ÙˆÙ‚Øª: $(date '+%Y-%m-%d %H:%M:%S')
          â€¢ Ø§Ù„Ø­Ø§Ù„Ø©: ${{ steps.extract.outputs.status }}"
          
          git pull --rebase origin ${{ github.ref_name }}
          git push origin ${{ github.ref_name }}
          echo "âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ù†Ø¬Ø§Ø­"
        } || echo "â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„ØªØ­Ø¯ÙŠØ«"
    
    - name: ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­
      if: success()
      uses: rjstone/discord-webhook-notify@v1
      with:
        webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
        severity: info
        details: |
          âœ… **ØªØ­Ø¯ÙŠØ« Ø¨Ø« Ø§Ù„Ø´Ø±ÙˆÙ‚ Ù†ÙŠÙˆØ² Ø¨Ù†Ø¬Ø§Ø­**
          **Ø§Ù„ÙˆÙ‚Øª:** ${{ steps.extract.outputs.timestamp }}
          **Ø§Ù„Ø­Ø§Ù„Ø©:** ${{ steps.extract.outputs.status }}
          [Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹](https://github.com/${{ github.repository }})
    
    - name: ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ÙØ´Ù„
      if: failure()
      uses: rjstone/discord-webhook-notify@v1
      with:
        webhookUrl: ${{ secrets.DISCORD_WEBHOOK }}
        severity: error
        details: |
          âŒ **ÙØ´Ù„ ØªØ­Ø¯ÙŠØ« Ø¨Ø« Ø§Ù„Ø´Ø±ÙˆÙ‚ Ù†ÙŠÙˆØ²**
          **Ø§Ù„ÙˆÙ‚Øª:** ${{ steps.extract.outputs.timestamp }}
          **Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:** ${{ github.repository }}
          [Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„Ø§Øª](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
    
    - name: ğŸš€ Ù†Ø´Ø± Ø¹Ù„Ù‰ GitHub Pages
      if: success() && github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./results
        publish_branch: gh-pages
        keep_files: false
        force_orphan: true
